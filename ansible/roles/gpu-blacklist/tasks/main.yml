---
# Blacklist the i915 GPU driver on headless servers to prevent
# kernel hard lockups caused by the hotplug polling loop (hpd_poll)

- name: Blacklist i915 GPU driver
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-i915.conf
    content: "blacklist i915\n"
    mode: "0644"
  become: true
  register: i915_blacklist

- name: Rebuild initramfs after blacklist change
  ansible.builtin.command: update-initramfs -u
  become: true
  when: i915_blacklist.changed
  notify: Reboot required
