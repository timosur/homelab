---
# tasks file for cilium

- name: Check if cilium CLI is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/cilium
  register: cilium_binary

- name: Detect architecture
  ansible.builtin.set_fact:
    cilium_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

- name: Create temporary directory for Cilium CLI
  ansible.builtin.tempfile:
    state: directory
    suffix: cilium
  register: cilium_temp_dir
  when: not cilium_binary.stat.exists

- name: Download Cilium CLI archive
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/{{ cilium_cli_version }}/cilium-linux-{{ cilium_arch }}.tar.gz"
    dest: "{{ cilium_temp_dir.path }}/cilium.tar.gz"
    mode: "0644"
  when: not cilium_binary.stat.exists

- name: Extract Cilium CLI binary
  ansible.builtin.unarchive:
    src: "{{ cilium_temp_dir.path }}/cilium.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    mode: "0755"
  when: not cilium_binary.stat.exists

- name: Clean up temporary directory
  ansible.builtin.file:
    path: "{{ cilium_temp_dir.path }}"
    state: absent
  when: not cilium_binary.stat.exists

- name: Wait for k3s API to be fully ready
  ansible.builtin.command: kubectl get nodes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 10
  delay: 10
  register: result
  until: result.rc == 0
  changed_when: false

- name: Get control plane node IP
  ansible.builtin.set_fact:
    control_plane_ip: "{{ hostvars['homelab-amd']['node_ip'] }}"

- name: Check if Cilium is already installed in cluster
  ansible.builtin.command: kubectl get pods -n kube-system -l k8s-app=cilium -o json
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: cilium_pods
  changed_when: false
  failed_when: false

- name: Set Cilium operation mode
  ansible.builtin.set_fact:
    cilium_operation: "{{ 'upgrade' if (cilium_pods.stdout | from_json | json_query('items') | length > 0) else 'install' }}"

- name: Install or upgrade Cilium with cluster mesh support
  ansible.builtin.command:
    cmd: >
      cilium {{ cilium_operation }}
      --set cluster.name=home
      --set cluster.id=2
      --set ipam.mode=kubernetes
      --set kubeProxyReplacement=true
      --set k8sServiceHost={{ control_plane_ip }}
      --set k8sServicePort=6443
      --set hubble.enabled=true
      --set hubble.relay.enabled=true
      --set hubble.ui.enabled=true
      --set routingMode=tunnel
      --set bpf.masquerade=true
      --set envoy.enabled=false
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: cilium_result
  changed_when: "'âœ… Cilium was successfully' in cilium_result.stdout"

- name: Enable Hubble
  ansible.builtin.command: cilium hubble enable
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: hubble_enable
  changed_when: "'already enabled' not in hubble_enable.stdout"
  failed_when: false

- name: Wait for Cilium to be ready
  ansible.builtin.command: cilium status --wait
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: cilium_status_result
  retries: 12
  delay: 10
  until: cilium_status_result.rc == 0
  changed_when: false

- name: Display Cilium status
  ansible.builtin.command: cilium status
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: final_cilium_status
  changed_when: false

- name: Show Cilium status
  ansible.builtin.debug:
    var: final_cilium_status.stdout_lines
