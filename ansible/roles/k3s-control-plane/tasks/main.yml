---
# tasks file for k3s-control-plane

- name: Install open-iscsi for Synology CSI iSCSI support
  ansible.builtin.package:
    name: open-iscsi
    state: present
  become: true

- name: Enable and start iscsid service
  ansible.builtin.systemd:
    name: iscsid
    state: started
    enabled: true
  become: true

- name: Ensure k3s config directory exists
  ansible.builtin.file:
    path: /etc/rancher/k3s
    state: directory
    mode: "0755"
  become: true

- name: Write k3s config (before install so it is picked up on first start)
  ansible.builtin.copy:
    dest: /etc/rancher/k3s/config.yaml
    content: |
      disable:
        - traefik
        - servicelb
      write-kubeconfig-mode: "0644"
      cluster-cidr: "10.50.0.0/16"
      service-cidr: "10.51.0.0/16"
      flannel-backend: "none"
      disable-network-policy: true
      disable-kube-proxy: true
      secrets-encryption: true
      kube-apiserver-arg:
        - "anonymous-auth=false"
        - "audit-policy-file=/etc/rancher/k3s/audit-policy.yaml"
        - "audit-log-path=/var/log/k3s-audit.log"
        - "audit-log-maxage=30"
        - "audit-log-maxbackup=10"
        - "audit-log-maxsize=100"
        - "enable-admission-plugins=NodeRestriction"
        - "service-account-lookup=true"
      kubelet-arg:
        - "protect-kernel-defaults=true"
        - "read-only-port=0"
    mode: "0600"
  become: true
  notify: Restart k3s

- name: Deploy Kubernetes audit policy
  ansible.builtin.copy:
    dest: /etc/rancher/k3s/audit-policy.yaml
    content: |
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        # Don't log read-only requests to certain resources
        - level: None
          resources:
            - group: ""
              resources: ["events"]
        # Don't log health checks
        - level: None
          users: ["system:kube-proxy"]
          verbs: ["watch"]
        # Don't log kubelet and node status reads
        - level: None
          userGroups: ["system:nodes"]
          verbs: ["get"]
          resources:
            - group: ""
              resources: ["nodes", "nodes/status"]
        # Log secret access at metadata level
        - level: Metadata
          resources:
            - group: ""
              resources: ["secrets", "configmaps"]
        # Log authentication/authorization events
        - level: Metadata
          resources:
            - group: "rbac.authorization.k8s.io"
              resources: ["clusterrolebindings", "rolebindings", "clusterroles", "roles"]
        # Log all write operations at request level
        - level: RequestResponse
          verbs: ["create", "update", "patch", "delete", "deletecollection"]
        # Everything else at metadata level
        - level: Metadata
    mode: "0600"
  become: true
  notify: Restart k3s

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Install k3s server
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" \
      INSTALL_K3S_EXEC="server" \
      INSTALL_K3S_SKIP_START=true \
      sh -
  become: true
  when: not k3s_binary.stat.exists
  args:
    creates: /usr/local/bin/k3s

- name: Ensure k3s unit file has no stale flags (re-run installer if needed)
  ansible.builtin.shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" \
      INSTALL_K3S_EXEC="server" \
      INSTALL_K3S_SKIP_START=true \
      sh -
  become: true
  when: k3s_binary.stat.exists
  register: k3s_reinstall
  changed_when: "'Creating service file' in k3s_reinstall.stdout"
  notify: Restart k3s

- name: Flush handlers (restart k3s if config changed)
  ansible.builtin.meta: flush_handlers

- name: Wait for k3s to be ready
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    timeout: 300

- name: Ensure k3s service is running
  ansible.builtin.systemd:
    name: k3s
    state: started
  become: true

- name: Wait for node-token file to be available
  ansible.builtin.wait_for:
    path: /var/lib/rancher/k3s/server/node-token
    timeout: 60

- name: Read k3s node token
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_node_token_raw
  become: true

- name: Set k3s token fact
  ansible.builtin.set_fact:
    k3s_token: "{{ k3s_node_token_raw['content'] | b64decode | trim }}"

- name: Display token info for debugging
  ansible.builtin.debug:
    msg: "K3S Token retrieved: {{ k3s_token[:5] }}..."

- name: Create .kube directory for timosur
  ansible.builtin.file:
    state: directory
    path: /home/timosur/.kube
    owner: timosur
    group: timosur
    mode: "0755"
  become: true

- name: Copy k3s kubeconfig
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /home/timosur/.kube/config
    owner: timosur
    group: timosur
    remote_src: true
    mode: "0600"
  become: true

- name: Set control_plane_ip fact
  ansible.builtin.set_fact:
    control_plane_ip: "{{ node_ip }}"
