---
# tasks file for k3s-update

- name: Check current k3s version
  ansible.builtin.shell: set -o pipefail && k3s --version | head -n1 || echo "Not installed"
  args:
    executable: /bin/bash
  register: current_k3s_version
  changed_when: false
  failed_when: false

- name: Display current k3s version
  ansible.builtin.debug:
    msg: "Current k3s version: {{ current_k3s_version.stdout }}"

- name: Check if update is needed
  ansible.builtin.set_fact:
    needs_update: "{{ k3s_version not in current_k3s_version.stdout }}"

- name: Display update status
  ansible.builtin.debug:
    msg: "Update needed: {{ needs_update }}, Target version: {{ k3s_version }}"

- name: Detect architecture
  ansible.builtin.set_fact:
    k3s_arch_suffix: "{{ '-arm64' if ansible_architecture == 'aarch64' else '' }}"

- name: Download new k3s binary
  ansible.builtin.get_url:
    url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s{{ k3s_arch_suffix }}"
    dest: /tmp/k3s-new
    mode: "0755"
  when: needs_update | bool

- name: Backup current k3s binary
  ansible.builtin.copy:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/k3s.backup
    remote_src: true
    mode: "0755"
  when: needs_update | bool

- name: Check if this is a control plane node
  ansible.builtin.stat:
    path: /etc/systemd/system/k3s.service
  register: is_control_plane

- name: Check if this is a worker node
  ansible.builtin.stat:
    path: /etc/systemd/system/k3s-agent.service
  register: is_worker

- name: Stop k3s service on control plane
  ansible.builtin.systemd:
    name: k3s
    state: stopped
  when:
    - needs_update | bool
    - is_control_plane.stat.exists

- name: Stop k3s-agent service on worker
  ansible.builtin.systemd:
    name: k3s-agent
    state: stopped
  when:
    - needs_update | bool
    - is_worker.stat.exists

- name: Replace k3s binary
  ansible.builtin.copy:
    src: /tmp/k3s-new
    dest: /usr/local/bin/k3s
    remote_src: true
    mode: "0755"
  when: needs_update | bool

- name: Start k3s service on control plane
  ansible.builtin.systemd:
    name: k3s
    state: started
    daemon_reload: true
  when:
    - needs_update | bool
    - is_control_plane.stat.exists

- name: Start k3s-agent service on worker
  ansible.builtin.systemd:
    name: k3s-agent
    state: started
    daemon_reload: true
  when:
    - needs_update | bool
    - is_worker.stat.exists

- name: Wait for k3s to be ready (control plane)
  ansible.builtin.wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    timeout: 120
  when:
    - needs_update | bool
    - is_control_plane.stat.exists

- name: Wait for node to be responsive
  ansible.builtin.pause:
    seconds: 20
- name: Verify new k3s version
  ansible.builtin.shell: set -o pipefail && k3s --version | head -n1
  args:
    executable: /bin/bash
  register: new_k3s_version
  changed_when: false

- name: Display new k3s version
  ansible.builtin.debug:
    msg: "New k3s version: {{ new_k3s_version.stdout }}"

- name: Clean up downloaded binary
  ansible.builtin.file:
    path: /tmp/k3s-new
    state: absent
  when: needs_update | bool

- name: Update successful message
  ansible.builtin.debug:
    msg: "k3s update completed successfully on {{ ansible_hostname }}"
  when: needs_update | bool

- name: No update needed message
  ansible.builtin.debug:
    msg: "k3s is already at version {{ k3s_version }} on {{ ansible_hostname }}"
  when: not (needs_update | bool)
