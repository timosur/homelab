---
# Node hardening tasks for all k3s cluster nodes
# Applies kernel sysctl hardening, disables unnecessary services,
# blacklists unused kernel modules, and hardens SSH, filesystem,
# and runtime security.

# ──────────────────────────────────────────────────────
# 0. Refresh apt cache (Debian/Ubuntu)
# ──────────────────────────────────────────────────────
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true
  when: ansible_os_family == "Debian"

# ──────────────────────────────────────────────────────
# 1. Kernel / network sysctl hardening (all nodes)
# ──────────────────────────────────────────────────────
- name: Apply kernel and network sysctl hardening
  ansible.builtin.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
    sysctl_file: /etc/sysctl.d/90-hardening.conf
  become: true
  loop: "{{ hardening_sysctl_params | dict2items }}"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"

# ──────────────────────────────────────────────────────
# 2. Disable unnecessary services (hardware-dependent)
# ──────────────────────────────────────────────────────
- name: Gather list of enabled services
  ansible.builtin.command: systemctl list-unit-files --state=enabled --type=service --no-pager
  register: enabled_services
  changed_when: false

- name: Disable unnecessary services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
  become: true
  when: item in enabled_services.stdout
  loop: "{{ common_disabled_services + (extra_disabled_services | default([])) }}"
  loop_control:
    label: "{{ item }}"
  ignore_errors: true

# ──────────────────────────────────────────────────────
# 3. Blacklist unused kernel modules (all nodes)
# ──────────────────────────────────────────────────────
- name: Blacklist unused and dangerous kernel modules
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-hardening.conf
    content: |
      # Blacklist unused/dangerous modules for headless k3s nodes
      {% for mod in common_blacklisted_modules + (extra_blacklisted_modules | default([])) %}
      blacklist {{ mod }}
      {% endfor %}
    mode: "0644"
  become: true
  register: module_blacklist

- name: Rebuild initramfs after module blacklist change (Debian/Ubuntu)
  ansible.builtin.command: update-initramfs -u
  become: true
  when:
    - module_blacklist.changed
    - ansible_os_family == "Debian"

# ──────────────────────────────────────────────────────
# 4. SSH hardening
# ──────────────────────────────────────────────────────
- name: Harden SSH configuration
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config.d/90-hardening.conf
    content: |
      # Hardening applied by Ansible
      PermitRootLogin no
      PasswordAuthentication no
      X11Forwarding no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2
      Banner /etc/issue.net
    mode: "0644"
  become: true
  notify: Restart sshd

# ──────────────────────────────────────────────────────
# 5. File system hardening
# ──────────────────────────────────────────────────────
- name: Set secure permissions on cron directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "0700"
  become: true
  loop:
    - /etc/cron.d
    - /etc/cron.daily
    - /etc/cron.hourly
    - /etc/cron.weekly
    - /etc/cron.monthly
  ignore_errors: true

- name: Set secure permissions on k3s datastore
  ansible.builtin.file:
    path: /var/lib/rancher/k3s/server/db
    owner: root
    group: root
    mode: "0700"
  become: true
  when: "'control_plane' in group_names"

# ──────────────────────────────────────────────────────
# 6. Core dump hardening
# ──────────────────────────────────────────────────────
- name: Disable core dumps via limits.conf
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-no-core-dumps.conf
    content: |
      # Disable core dumps — prevents leaking sensitive memory
      * hard core 0
    mode: "0644"
  become: true

- name: Disable core dumps via sysctl
  ansible.builtin.sysctl:
    name: fs.suid_dumpable
    value: "0"
    sysctl_set: true
    state: present
    reload: true
    sysctl_file: /etc/sysctl.d/90-hardening.conf
  become: true

# ──────────────────────────────────────────────────────
# 7. /tmp mount hardening
# ──────────────────────────────────────────────────────
- name: Ensure /tmp is mounted with noexec,nosuid,nodev
  ansible.posix.mount:
    path: /tmp
    src: tmpfs
    fstype: tmpfs
    opts: defaults,noexec,nosuid,nodev,size=512M
    state: mounted
  become: true

# ──────────────────────────────────────────────────────
# 8. Restrict su to sudo group
# ──────────────────────────────────────────────────────
- name: Restrict su to sudo group via PAM
  ansible.builtin.lineinfile:
    path: /etc/pam.d/su
    regexp: '^#?\s*auth\s+required\s+pam_wheel\.so'
    line: "auth       required   pam_wheel.so use_uid group=sudo"
    state: present
  become: true

# ──────────────────────────────────────────────────────
# 9. Login banner
# ──────────────────────────────────────────────────────
- name: Set login warning banner
  ansible.builtin.copy:
    dest: /etc/issue.net
    content: |
      ******************************************************************
      * WARNING: Unauthorized access to this system is prohibited.     *
      * All connections are monitored and recorded.                     *
      * Disconnect IMMEDIATELY if you are not an authorized user.      *
      ******************************************************************
    mode: "0644"
  become: true

# ──────────────────────────────────────────────────────
# 10. Custom MOTD banner
# ──────────────────────────────────────────────────────
- name: Deploy custom MOTD script
  ansible.builtin.copy:
    dest: /etc/update-motd.d/99-custom
    content: |
      #!/bin/bash
      echo ""
      echo "******************************************************************"
      echo "* WARNING: Unauthorized access to this system is prohibited.     *"
      echo "* All connections are monitored and recorded.                     *"
      echo "* Disconnect IMMEDIATELY if you are not an authorized user.      *"
      echo "******************************************************************"
      echo ""
      echo "  Hostname : $(hostname)"
      echo "  Role     : k3s cluster node (managed by Ansible)"
      echo ""
    mode: "0755"
  become: true

# ──────────────────────────────────────────────────────
# 11. Automatic security updates
# ──────────────────────────────────────────────────────
- name: Install unattended-upgrades
  ansible.builtin.package:
    name:
      - unattended-upgrades
      - apt-listchanges
    state: present
  become: true
  when: ansible_os_family == "Debian"

- name: Configure unattended-upgrades for security only
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    mode: "0644"
  become: true
  when: ansible_os_family == "Debian"

- name: Enable automatic updates
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
    mode: "0644"
  become: true
  when: ansible_os_family == "Debian"

# ──────────────────────────────────────────────────────
# 12. Fail2ban for SSH
# ──────────────────────────────────────────────────────
- name: Install fail2ban
  ansible.builtin.package:
    name: fail2ban
    state: present
  become: true

- name: Configure fail2ban SSH jail
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.d/sshd.conf
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      maxretry = 3
      bantime = 3600
      findtime = 600
    mode: "0644"
  become: true
  notify: Restart fail2ban

- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
  become: true

# ──────────────────────────────────────────────────────
# 13. Audit logging (auditd)
# ──────────────────────────────────────────────────────
- name: Install auditd
  ansible.builtin.package:
    name: auditd
    state: present
  become: true

- name: Deploy audit rules for k3s nodes
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/99-hardening.rules
    content: |
      # Monitor authentication files
      -w /etc/shadow -p wa -k shadow-change
      -w /etc/passwd -p wa -k passwd-change
      -w /etc/group -p wa -k group-change
      -w /etc/gshadow -p wa -k gshadow-change

      # Monitor SSH config
      -w /etc/ssh/sshd_config -p wa -k sshd-config
      -w /etc/ssh/sshd_config.d -p wa -k sshd-config

      # Monitor k3s directories
      -w /etc/rancher/k3s/ -p wa -k k3s-config
      -w /var/lib/rancher/k3s/ -p wa -k k3s-data

      # Monitor sudoers
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers

      # Monitor kernel module loading
      -w /sbin/insmod -p x -k kernel-modules
      -w /sbin/rmmod -p x -k kernel-modules
      -w /sbin/modprobe -p x -k kernel-modules

      # Log all commands run as root
      -a always,exit -F arch=b64 -F euid=0 -S execve -k root-commands
    mode: "0640"
  become: true
  notify: Restart auditd

- name: Enable and start auditd
  ansible.builtin.systemd:
    name: auditd
    state: started
    enabled: true
  become: true

# ──────────────────────────────────────────────────────
# 14. NTP time synchronization
# ──────────────────────────────────────────────────────
- name: Ensure chrony is installed
  ansible.builtin.package:
    name: chrony
    state: present
  become: true

- name: Enable and start chrony
  ansible.builtin.systemd:
    name: chronyd
    state: started
    enabled: true
  become: true
