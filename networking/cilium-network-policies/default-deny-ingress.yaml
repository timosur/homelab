# Default deny all ingress traffic cluster-wide.
# Each namespace must explicitly allow the ingress it needs via
# its own CiliumNetworkPolicy. System namespaces are excluded.
#
# How this works: selecting endpoints and specifying enableDefaultDeny
# for ingress means any traffic not explicitly allowed by another
# policy will be dropped.
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  description: "Default deny all ingress for non-system namespaces"
  endpointSelector:
    matchExpressions:
      - key: io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name
        operator: NotIn
        values:
          - kube-system
          - cilium-system
          - cilium-secrets
          - cert-manager
          - cnpg-system
          - argocd
          - external-secrets-system
          - envoy-gateway-system
          - envoy-gateway-internet-system
  ingress:
    # Allow kubelet health probes from node IPs (host network)
    - fromEntities:
        - host
    # Allow intra-namespace traffic (pods in the same namespace)
    - fromEndpoints:
        - {}
    # Allow traffic from envoy gateway (ingress)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: envoy-gateway-system
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: envoy-gateway-internet-system
  enableDefaultDeny:
    ingress: true
    egress: false
