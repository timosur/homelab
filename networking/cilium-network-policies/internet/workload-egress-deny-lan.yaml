# Cluster-wide policy: any namespace with label "exposure: internet" gets
# restricted egress â€” deny access to LAN subnets so compromised internet-
# facing workloads cannot reach intranet resources.
#
# Apply this label to namespaces that host internet-exposed apps:
#   kubectl label ns <namespace> exposure=internet
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: internet-workload-egress-deny-lan
spec:
  endpointSelector:
    matchLabels:
      io.cilium.k8s.namespace.labels.exposure: internet
  egress:
    # Allow DNS
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow traffic to the Kubernetes API server (runs on the host,
    # not as a pod, so toEndpoints won't match it)
    - toEntities:
        - kube-apiserver
    # Allow traffic to all cluster endpoints (toCIDR alone won't match
    # in-cluster endpoints because Cilium resolves them to pod identities)
    - toEndpoints:
        - {}
    # Allow external internet but deny LAN
    - toCIDRSet:
        - cidr: 0.0.0.0/0
          except:
            - 192.168.0.0/16
            - 172.16.0.0/12
