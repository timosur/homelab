# Cluster-wide policy: any namespace with label "exposure: internet" gets
# restricted egress — deny access to LAN subnets so compromised internet-
# facing workloads cannot reach intranet resources.
#
# Apply this label to namespaces that host internet-exposed apps:
#   kubectl label ns <namespace> exposure=internet
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: internet-workload-egress-deny-lan
spec:
  endpointSelector:
    matchLabels:
      io.cilium.k8s.namespace.labels.exposure: internet
  egress:
    # Allow DNS
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow cluster-internal pod traffic
    - toCIDR:
        - 10.50.0.0/16
    # Allow cluster-internal service traffic
    - toCIDR:
        - 10.51.0.0/16
    # Allow external internet (for APIs, etc.)
    - toCIDR:
        - 0.0.0.0/0
      toCIDRSet:
        - cidr: 0.0.0.0/0
          except:
            - 192.168.0.0/16
            - 172.16.0.0/12
            - 10.0.0.0/8
  egressDeny:
    # Explicit deny to LAN — defense in depth
    - toCIDR:
        - 192.168.0.0/16
        - 172.16.0.0/12
