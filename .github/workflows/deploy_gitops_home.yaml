name: Deploy GitOps Home

on:
  workflow_dispatch:

jobs:
  deploy_gitops_home:
    runs-on: ubuntu-latest

    environment:
      name: home-production

    steps:
      - uses: actions/checkout@v6

      - name: Setup Python and Ansible
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible and dependencies
        run: |
          pip install ansible kubernetes
          ansible-galaxy collection install kubernetes.core

      - name: Setup kubeconfig for home cluster
        run: |
          # Create kubeconfig directory
          mkdir -p ~/.kube

          # Copy /etc/rancher/k3s/k3s.yaml to kubeconfig
          cp /etc/rancher/k3s/k3s.yaml ~/.kube/config

          # Set permissions
          chmod 600 ~/.kube/config

          # Test connectivity
          kubectl cluster-info
          kubectl get nodes

      - name: Create temporary inventory for localhost
        run: |
          cat <<EOF > /tmp/inventory.yml
          all:
            hosts:
              localhost:
                ansible_connection: local
            vars:
              argocd_version: "v3.2.3"
              azure_client_id: "${{ secrets.AZURE_SP_CLIENT_ID }}"
              azure_client_secret: "${{ secrets.AZURE_SP_CLIENT_SECRET }}"
              azure_tenant_id: "${{ secrets.AZURE_TENANT_ID }}"
              azure_subscription_id: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
              azure_keyvault_name: "${{ secrets.AZURE_KEYVAULT_NAME }}"
          EOF

      - name: Run ArgoCD and GitOps setup with Ansible
        run: |
          cd ansible
          ansible-playbook -i /tmp/inventory.yml playbooks/argocd-gitops-setup.yml -v

      - name: Display Access Information
        run: |
          echo "============================================="
          echo "GitOps setup completed for home cluster!"
          echo "============================================="
          echo ""
          echo "To access ArgoCD UI:"
          echo "1. Port forward: kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "2. Get admin password:"
          echo "   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d"
          echo "3. Open https://localhost:8080 and login with username 'admin'"
          echo ""
          echo "Applications deployed:"
          kubectl get applications -n argocd --no-headers 2>/dev/null | awk '{print "- " $1 " (" $3 ")"}' || echo "- Root application deployed, others will follow"
          echo ""
          echo "Monitor deployment status in ArgoCD UI"
          echo "============================================="
