apiVersion: batch/v1
kind: Job
metadata:
  name: patch-wireguard-claim
  namespace: home-integration
spec:
  template:
    spec:
      serviceAccountName: wireguard-patcher
      containers:
      - name: kubectl-patch
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          # Wait for the secret to exist
          echo "Waiting for wireguard-config secret..."
          while ! kubectl get secret wireguard-config -n home-integration >/dev/null 2>&1; do
            sleep 5
          done
          
          # Extract values from secret
          FRITZBOX_KEY=$(kubectl get secret wireguard-config -n home-integration -o jsonpath='{.data.fritzbox_public_key}' | base64 -d)
          HOME_IP=$(kubectl get secret wireguard-config -n home-integration -o jsonpath='{.data.home_public_ip}' | base64 -d)
          
          # Patch the claim with actual values
          kubectl patch xwireguardgateway home-vpn-gateway -n home-integration --type='merge' -p="{
            \"spec\": {
              \"parameters\": {
                \"wireguardConfig\": {
                  \"fritzboxPublicKey\": \"$FRITZBOX_KEY\",
                  \"homePublicIP\": \"$HOME_IP\"
                }
              }
            }
          }"
          
          echo "Successfully patched wireguard claim with secret values"
      restartPolicy: OnFailure
  backoffLimit: 5