apiVersion: batch/v1
kind: CronJob
metadata:
  name: garden-db-backup
  namespace: garden
spec:
  schedule: "0 2 * * *" # 2 AM daily
  timeZone: "Europe/Berlin"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: postgres:17-alpine
              command: ["sh", "-c"]
              args:
                - |
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)

                  echo "Starting pg_dump backup..."
                  PGPASSWORD="$DB_PASSWORD" pg_dump \
                    -h garden-postgres-rw \
                    -U garden \
                    -d garden \
                    -F c \
                    -f "/backups/backup-${TIMESTAMP}.dump"

                  if [ $? -eq 0 ]; then
                    echo "Backup created successfully: backup-${TIMESTAMP}.dump ($(du -h /backups/backup-${TIMESTAMP}.dump | cut -f1))"
                  else
                    echo "Backup failed"
                    exit 1
                  fi

                  # Clean up old backups (keep last 30 days)
                  find /backups -name "backup-*.dump" -mtime +30 -delete 2>/dev/null || true

                  echo "Current backups:"
                  ls -lah /backups/backup-*.dump 2>/dev/null || echo "No backups found"
              envFrom:
                - secretRef:
                    name: garden-postgres-password
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              hostPath:
                path: /var/lib/garden/backups
                type: DirectoryOrCreate
