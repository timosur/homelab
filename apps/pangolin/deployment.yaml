apiVersion: apps/v1
kind: Deployment
metadata:
  name: pangolin
  namespace: pangolin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pangolin
  template:
    metadata:
      labels:
        app: pangolin
    spec:
      initContainers:
        - name: init-directories
          image: busybox:1.37
          command: ["sh", "-c", "mkdir -p /app/config /var/certificates /var/dynamic && chown -R 1000:1000 /app /var/certificates /var/dynamic"]
          volumeMounts:
            - name: pangolin-config-pvc
              mountPath: /app/config
            - name: pangolin-data
              mountPath: /var/certificates
              subPath: certificates
            - name: pangolin-data
              mountPath: /var/dynamic
              subPath: dynamic
        - name: config-generator
          image: alpine:3.22
          env:
            - name: SERVER_SECRET
              valueFrom:
                secretKeyRef:
                  name: pangolin-secrets
                  key: SERVER_SECRET
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pangolin-postgres-credentials
                  key: password
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache gettext
              envsubst < /tmp/config-template/config.yml.template > /app/config/config.yml
              chown 1000:1000 /app/config/config.yml
          volumeMounts:
            - name: config-template
              mountPath: /tmp/config-template
            - name: config-volume
              mountPath: /app/config
      containers:
        - name: pangolin
          image: fosrl/pangolin:latest
          ports:
            - containerPort: 3001
              name: api
            - containerPort: 3000
              name: websocket
            - containerPort: 3002
              name: nextjs
          volumeMounts:
            - name: config-volume
              mountPath: /app/config
            - name: pangolin-data
              mountPath: /var/certificates
              subPath: certificates
            - name: pangolin-data
              mountPath: /var/dynamic
              subPath: dynamic
          resources:
            limits:
              memory: "1000Mi"
              cpu: "1000m"
            requests:
              memory: "512Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /api/v1/
              port: 3001
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/v1/
              port: 3001
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config-template
          configMap:
            name: pangolin-config
        - name: config-volume
          emptyDir: {}
        - name: pangolin-config-pvc
          persistentVolumeClaim:
            claimName: pangolin-config
        - name: pangolin-data
          persistentVolumeClaim:
            claimName: pangolin-data